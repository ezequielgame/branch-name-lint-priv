#!/usr/bin/env node

import BranchNameLint from '#src/index.js';
import { findUpSync } from 'find-up';
import { readFileSync } from 'fs';
import meow from 'meow';

const cli = meow(`
	Usage
	  $ npx branch-name-lint [configuration-file.json]

	Options
	  --help - to get this screen

	Examples
	  $ branch-name-lint
	  Use default configuration or the configuration specified in package.json to validate & lint the branch name.
	  $ branch-name-lint [configuration-file.json]
	  Use configuration file to validate & lint the branch name.
`, {
  importMeta: import.meta, // This is required
  flags: {
    branch: {
      type: 'string',
      shortFlag: 'b'
    },
    verbose: {
      type: 'boolean',
      shortFlag: 'v'
    },
    quiet: {
      type: 'boolean',
      shortFlag: 'q'
    },
    mute: {
      type: 'boolean',
      shortFlag: 'm'
    },
  }
});
const configFileName = cli.input[0];

class BranchNameLintCli {
  constructor() {
    this.options = this.loadConfiguration(configFileName);
    const branchNameLint = new BranchNameLint(this.options, cli.flags);
    const answer = branchNameLint.doValidation();
    if (answer === 1) {
      process.exit(1);
    }
  }

  loadConfiguration (filename = 'package.json') {
    const pkgFile = findUpSync(filename);
    const pkg = JSON.parse(readFileSync(pkgFile));
    return (pkg.branchNameLinter) || {};
  }
}

new BranchNameLintCli(); // eslint-disable-line no-new
